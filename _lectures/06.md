# Идентификация, аутентификация, авторизация

# Если коротко, то:
- Идентификация — процесс распознавания пользователя по его идентификатору.
- Аутентификация — процедура проверки подлинности, доказательство что пользователь именно тот, за кого себя выдает.
- Авторизация — предоставление определённых прав.


# Теперь по отдельности:
## Идентификация 

процедура, в результате выполнения которой для субъекта идентификации выявляется его идентификатор, однозначно идентифицирующий этого субъекта в информационной системе. Для выполнения процедуры идентификации в информационной системе субъекту предварительно должен быть назначен соответствующий идентификатор (то есть проведена регистрация субъекта в информационной системе).

Рассмотрим на примере:
У нас есть система заметок (api сервер и бд из 2х таблиц).
Таблица `users`

| id | login    |
| -- | -------- |
| 1  | username |

и таблица `notes`

| id | notes     |
| -- | --------- |
| 1  | some text |

Перед нами ставится задача при запросе конкретной заметки провести идентификацию пользователя. Как это будет выглядеть?
```js
    @Get('/notes')
    public async get(
      @Params('id') note_id: number, 
      @Params('login') login: string,
    ) {
      // идентифицируем пользователя
      const user = await db.users.find({ where: { login }});
      // если пользователь не идентифицирован, возвращаем ошибку
      if (!user) {
        // возвращаем ошибку, так как ситуация вакумная и идентификация не проходит без аутентификации, то и специально httpcode для нее нет.
        // поэтому возвращаем httpcode 401 Unauthorized
        throw new UnauthorizedError();
      }
      const note = await db.notes.find({ where: { id: note_id }});
      if (!note) {
        throw new NotFoundError();
      }
      return note;
    }
```
Это пример идентификации, другой пример идентификатора вас как пользователя — это ссылка в vk или fb. Перейдите на свою страницу и посмотрите в адресную строку, одна будет иметь формат `https://vk.com/${identification}` или `https://www.facebook.com/${identification}`. 
Но идентификация никогда не проходит отдельно от аутентификации. Никто не верит “на слово”)


## Аутентификация

процедура проверки подлинности, например:

- проверка подлинности пользователя путём сравнения введённого им пароля (для указанного логина) с паролем, сохранённым в базе данных пользовательских логинов;
- подтверждение подлинности электронного письма путём проверки цифровой подписи письма по открытому ключу отправителя;
- проверка контрольной суммы файла на соответствие сумме, заявленной автором этого файла.

**Факторы аутентификации**
Ещё до появления компьютеров использовались различные отличительные черты субъекта, его характеристики. Сейчас использование той или иной характеристики в системе зависит от требуемой надёжности, защищённости и стоимости внедрения. Выделяют 3 фактора аутентификации:

- **Нечто, что нам известно, например, какая-либо секретная информация**. Это тайные сведения, которыми должен обладать только авторизованный субъект. Секретом может быть некая фраза или пароль, например в виде устного сообщения, текстового представления, комбинации для замка или личного идентификационного номера (PIN). Парольный механизм может быть довольно легко воплощён и имеет низкую стоимость. Но имеет существенные недостатки: сохранить пароль в тайне зачастую бывает сложно, злоумышленники постоянно придумывают новые способы кражи, взлома и подбора пароля (см. бандитский криптоанализ, метод грубой силы). Это делает парольный механизм слабозащищённым.
- **Нечто, чем мы обладаем, например, какой-либо уникальный физический объект**. Здесь важно обстоятельство обладания субъектом каким-то неповторимым предметом. Это может быть личная печать, ключ от замка, для компьютера это файл данных, содержащих характеристику. Характеристика часто встраивается в особое устройство аутентификации, например, пластиковая карта, смарт-карта. Для злоумышленника заполучить такое устройство становится более сложно, чем взломать пароль, а субъект может сразу же сообщить в случае кражи устройства. Это делает данный метод более защищённым, чем парольный механизм, однако стоимость такой системы более высокая.
- **Нечто, что является неотъемлемой частью нас самих — биометрика**. Характеристикой является физическая особенность субъекта. Это может быть портрет, отпечаток пальца или ладони, голос или особенность глаза. С точки зрения субъекта, данный способ является наиболее простым: не надо ни запоминать пароль, ни переносить с собой устройство аутентификации. Однако биометрическая система должна обладать высокой чувствительностью, чтобы подтверждать авторизованного пользователя, но отвергать злоумышленника со схожими биометрическими параметрами. Также стоимость такой системы довольно велика. Но, несмотря на свои недостатки, биометрика остается довольно перспективным фактором.

Рассмотрим на примере, как будет выглядеть аутентификация в нашей системе заметок. Для этого нам надо в таблицу пользователя добавить поле, в котором будет храниться фактор авторизации (для простоты пароль). Обновленная таблица пользователей `users` будет выглядеть следующим образом:

| id | login    | password |
| -- | -------- | -------- |
| 1  | username | qwerty   |

Таблица `notes` без изменений:

| id | notes     |
| -- | --------- |
| 1  | some text |

Реализация нашего метода тоже изменится:
```js
    @Get('/notes')
    public async get(
      @Params('id') note_id: number, 
      @Params('login') login: string,
      @Params('password') password: string,
    ) {
      // теперь мы не только идентифицируем пользователя, но и проверяем что у него указанный пароль, другими словами проводим аутентификацию
      const user = await db.users.find({ where: { login, password }});
      // если пользователь не идентифицирован, возвращаем ошибку
      if (!user) {
        // 401 Unauthorized
        throw new UnauthorizedError();
      }
      const note = await db.notes.find({ where: { id: note_id }});
      if (!note) {
        throw new NotFoundError();
      }
      return note;
    }
```

## Авторизация

предоставление определённому лицу или группе лиц прав на выполнение определённых действий; а также процесс проверки (подтверждения) данных прав при попытке выполнения этих действий.
Сразу к примеру! Что бы провести авторизацию и убедиться что пользователь имеет право доступа к записи добавим в таблицу заметки `notes` внешний ключ на пользователя, которому она принадлежит.

| id | notes     | user_id |
| -- | --------- | ------- |
| 1  | some text | 1       |

Таблица `users` без изменений:

| id | login    | password |
| -- | -------- | -------- |
| 1  | username | qwerty   |

Теперь наш метод опять изменится:
```js
    @Get('/notes')
    public async get(
      @Params('id') note_id: number, 
      @Params('login') login: string,
      @Params('password') password: string,
    ) {
      // теперь мы не только идентифицируем пользователя, но и проверяем что у него указанный пароль, другими словами проводим аутентификацию
      const user = await db.users.find({ where: { login, password }});
      // если пользователь не идентифицирован, возвращаем ошибку
      if (!user) {
        // 401 Unauthorized
        throw new UnauthorizedError();
      }
      const note = await db.notes.find({ where: { id: note_id }});
      if (!note) {
        throw new NotFoundError();
      }
      // проверяем, имеет ли пользователь права на чтение заметки,
      // фактически проводим авторизацию
      if (note.user_id !== user.id) {
        // 403 Forbidden
        throw new ForbiddenError();
      }
      return note;
    }
```

# Токен авторизации

Токены авторизации различаются по типам. Рассмотрим их:

1. Устройства, которые необходимо подключить физически. Например: ключи, диски и тому подобные. Тот, кто когда-либо использовал USB-устройство или смарт-карту для входа в систему, сталкивался с подключенным токеном.
2. Устройства, которые находятся достаточно близко к серверу, чтобы установить с ним соединение, но оно не подключаются физически. Примером такого типа токенов может служить "magic ring" от компании Microsoft.
3. устройства, которые могут взаимодействовать с сервером на больших расстояниях.

Во всех трех случаях пользователь должен что-то сделать, чтобы запустить процесс. Например, ввести пароль или ответить на вопрос. Но даже когда эти шаги совершаются без ошибок, доступ без токена получить невозможно.


## Процесс токен авторизации

Авторизация с помощью токена происходит следующим образом. Сначала человек запрашивает доступ к серверу или защищенному ресурсу. Запрос обычно включает в себя ввод логина и пароля. Затем сервер определяет, может ли пользователь получить доступ. После этого сервер взаимодействует с устройством: ключ, телефон, USB или что-то ещё. После проверки сервер выдает токен и отправляет пользователю. Токен находится в браузере, пока работа продолжается. Если пользователь попытается посетить другую часть сервера, токен опять связывается с ним. Доступ предоставляется или, наоборот, запрещается на основе выданного токена.
Администраторы устанавливают ограничения на токены. Можно разрешить одноразовый токен, который немедленно уничтожается, когда человек выходит из системы. Иногда устанавливается маркер на самоуничтожение в конце определенного периода времени.


## Как токены работают?

Во многих случаях токены создаются с помощью донглов или брелоков, которые генерируют новый токен аутентификации каждые 60 секунд в соответствии с заданным алгоритмом. Из-за мощности этих аппаратных устройств пользователи должны постоянно держать их в безопасности, чтобы они не попали в чужие руки. Таким образом, члены команды должны отказаться от своего ключа или брелока, если команда распадается.
Наиболее распространенные системы токенов содержат заголовок, полезную нагрузку и подпись. Заголовок состоит из типа полезной нагрузки, а также используемого алгоритма подписи. Полезная нагрузка содержит любые утверждения, относящиеся к пользователю. Подпись используется для доказательства того, что сообщение не подвергалось опасности при передаче. Эти три элемента работают вместе, чтобы создать высокоэффективную и безопасную систему аутентификации.

